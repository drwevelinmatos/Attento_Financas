<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Financeiro Clínica Attento</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat&family=Work+Sans&display=swap" rel="stylesheet" />
<style>
  :root { --verde-claro: #aaccbe; --cinza-escuro: #575755; }
  body { font-family: 'Work Sans', Arial, sans-serif; margin: 20px; background: #f7f7f7; color: var(--cinza-escuro);}
  h1, h2, h3 { font-family: 'Montserrat', sans-serif; color: var(--cinza-escuro); }
  section { background: white; padding: 20px 25px; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.07);}
  label { display: block; margin: 10px 0 6px; font-weight: 600;}
  input, select, textarea { width: 100%; padding:7px; border: 1.5px solid var(--verde-claro); border-radius: 6px; font-size: 1rem; background: #fafafa; color: var(--cinza-escuro);}
  button { margin-top:8px; background: var(--verde-claro); color:#fff; border:none; padding:10px 16px; border-radius:6px; font-weight:600; font-size:1rem; cursor:pointer;}
  button:hover { background: #86b6a4;}
  table { border-collapse:collapse; width:100%; margin-top:10px;}
  th,td { border: 1.2px solid var(--verde-claro); padding:8px 12px;}
  th { background: var(--verde-claro);}
  .input-row { display:flex; gap:16px }
  .input-row > div { flex:1; }
  .hidden { display:none; }
  #logo-container { text-align:center; margin-bottom:30px;}
  #logo-container img { max-width:140px; }
  #logo-container .tagline {font-family:'Montserrat',sans-serif;font-weight:600;font-size:1rem;color:var(--verde-claro);}
  .small-btn {font-size:0.93em;padding:3px 8px;}
  .anotacao-row {background: #f7f7f7; padding: 8px; margin-top:8px;}
</style>
</head>
<body>

<div id="logo-container">
  <img src="logo-attento.png" alt="Logo Clínica Attento" />
  <div class="tagline">INSTITUTO DE SAÚDE ESPECIALIZADA</div>
</div>

<h1>Financeiro Clínica Attento</h1>

<section id="investimentos">
  <h2>Investimento Inicial e Aportes</h2>
  <form id="investmentForm">
    <div class="input-row">
      <div>
        <label for="socioName">Sócio</label>
        <input type="text" id="socioName" placeholder="Nome do sócio" required />
      </div>
      <div>
        <label for="initialInvestment">Investimento Inicial (R$)</label>
        <input type="number" id="initialInvestment" min="0" step="0.01" />
      </div>
    </div>
    <div class="input-row">
      <div>
        <label for="aporteValue">Aporte Adicional (R$)</label>
        <input type="number" id="aporteValue" min="0" step="0.01" />
      </div>
      <div>
        <label for="aporteData">Data do Aporte</label>
        <input type="date" id="aporteData" />
      </div>
    </div>
    <button type="submit">Registrar</button>
  </form>
  <h3>Resumo</h3>
  <div id="investmentSummary"></div>
</section>

<section>
  <button id="btnCategorias">Categorias</button>
  <div id="categoriasBox" class="hidden">
    <h2>Criar/Editar Categoria e Subcategoria</h2>
    <form id="categoriaForm">
      <div class="input-row">
        <div>
          <label for="tipoCategoria">Tipo</label>
          <select id="tipoCategoria">
            <option value="entrada">Entrada</option>
            <option value="saida">Saída</option>
          </select>
        </div>
        <div>
          <label for="nomeCategoriaNova">Categoria</label>
          <input type="text" id="nomeCategoriaNova" required>
        </div>
        <div>
          <label for="subCategoriaNova">Subcategoria (opcional)</label>
          <input type="text" id="subCategoriaNova">
        </div>
      </div>
      <button type="submit">Adicionar</button>
    </form>
    <h3>Categorias Existentes</h3>
    <div id="categoriasList"></div>
    <button onclick="document.getElementById('categoriasBox').classList.add('hidden')">Fechar</button>
  </div>
</section>

<section id="entrada-section">
  <h2>Lançar Entrada</h2>
  <form id="entradaForm">
    <div class="input-row">
      <div>
        <label for="entradaCategoria">Categoria</label>
        <select id="entradaCategoria" required></select>
      </div>
      <div>
        <label for="entradaSubcategoria">Subcategoria</label>
        <select id="entradaSubcategoria"></select>
      </div>
      <div>
        <label for="entradaValor">Valor (R$)</label>
        <input type="number" id="entradaValor" min="0" step="0.01" required>
      </div>
      <div>
        <label for="entradaData">Data</label>
        <input type="date" id="entradaData" required>
      </div>
    </div>
    <button type="submit">Registrar Entrada</button>
  </form>
</section>

<section id="saida-section">
  <h2>Lançar Saída</h2>
  <form id="saidaForm">
    <div class="input-row">
      <div>
        <label for="saidaCategoria">Categoria</label>
        <select id="saidaCategoria" required></select>
      </div>
      <div>
        <label for="saidaSubcategoria">Subcategoria</label>
        <select id="saidaSubcategoria"></select>
      </div>
      <div>
        <label for="saidaValor">Valor (R$)</label>
        <input type="number" id="saidaValor" min="0" step="0.01" required>
      </div>
      <div>
        <label for="saidaData">Data</label>
        <input type="date" id="saidaData" required>
      </div>
    </div>
    <button type="submit">Registrar Saída</button>
  </form>
</section>

<section id="controle-aluguel">
  <h2>Controle de Recebimentos de Aluguel</h2>
  <form id="aluguelForm">
    <div class="input-row">
      <div>
        <label for="profissionalNome">Profissional</label>
        <input type="text" id="profissionalNome" required />
      </div>
      <div>
        <label for="periodosSemana">Períodos da Semana</label>
        <input type="text" id="periodosSemana" required placeholder="Ex: Segunda - Manhã, Terça - Tarde" />
      </div>
      <div>
        <label for="valorMensal">Valor Mensal (R$)</label>
        <input type="number" id="valorMensal" min="0" step="0.01" required />
      </div>
      <div>
        <label for="dataInicioAluguel">Data de Início</label>
        <input type="date" id="dataInicioAluguel" required />
      </div>
      <div>
        <label for="dataEncerramentoAluguel">Data de Encerramento</label>
        <input type="date" id="dataEncerramentoAluguel" />
      </div>
    </div>
    <button type="submit">Salvar</button>
  </form>
  <form id="anotacaoAluguelForm" class="hidden">
    <h3>Anotações Extras</h3>
    <input type="hidden" id="idxAluguel"/>
    <div class="input-row">
      <div>
        <label for="dataAnotacao">Data</label>
        <input type="date" id="dataAnotacao" required>
      </div>
      <div>
        <label for="textoAnotacao">Texto</label>
        <input type="text" id="textoAnotacao" required>
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button type="submit">Salvar</button>
      </div>
    </div>
  </form>
  <h3>Profissionais Cadastrados</h3>
  <div id="listaProfissionais"></div>
</section>

<section id="relatorios-section">
  <h2>Relatórios e Balanço</h2>
  <form id="relatorioForm">
    <div class="input-row">
      <div>
        <label for="relatoInicio">Data Início</label>
        <input type="date" id="relatoInicio" required>
      </div>
      <div>
        <label for="relatoFim">Data Fim</label>
        <input type="date" id="relatoFim" required>
      </div>
      <div>
        <label for="tipoRelatorio">Tipo de Relatório</label>
        <select id="tipoRelatorio">
          <option value="balanco">Balanço Geral</option>
          <option value="aporte">Aporte por Sócio</option>
          <option value="entrada">Por Categoria (Entradas)</option>
          <option value="saida">Por Categoria (Saídas)</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button type="submit">Gerar</button>
      </div>
    </div>
  </form>
  <div id="relat"></div>
</section>

<script>
(() => {
  // ---------- DADOS BASE ----------
  let categorias = JSON.parse(localStorage.getItem('attento_categorias_v4')) || [
    { tipo:"entrada", categoria:"Aporte", subcategorias:["Jessica","Wevelin"] },
    { tipo:"entrada", categoria:"Notas", subcategorias:["Jessica","Wevelin"] },
    { tipo:"saida", categoria:"Funcionario", subcategorias:["Karina","Leila"] },
    { tipo:"saida", categoria:"Aluguel", subcategorias:["Consultório","Auditório"] }
  ];
  let investimentos = JSON.parse(localStorage.getItem('attento_investimentos_v4')) || [];
  let entradas = JSON.parse(localStorage.getItem('attento_entradas_v4')) || [];
  let saidas = JSON.parse(localStorage.getItem('attento_saidas_v4')) || [];
  let alugueis = JSON.parse(localStorage.getItem('attento_alugueis_v4')) || [];

  function saveAll() {
    localStorage.setItem('attento_categorias_v4', JSON.stringify(categorias));
    localStorage.setItem('attento_investimentos_v4', JSON.stringify(investimentos));
    localStorage.setItem('attento_entradas_v4', JSON.stringify(entradas));
    localStorage.setItem('attento_saidas_v4', JSON.stringify(saidas));
    localStorage.setItem('attento_alugueis_v4', JSON.stringify(alugueis));
  }
  function formatCurrency(v){return (+v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
  function formatDate(date){return date?new Date(date).toLocaleDateString("pt-BR"):"";}
  function genId(){return Math.random().toString(36).substr(2,9);}

  // ---------- BOX CATEGORIAS ----------
  document.getElementById("btnCategorias").onclick = function(){
    document.getElementById("categoriasBox").classList.remove("hidden");
  };
  document.getElementById("categoriaForm").onsubmit = function(e){
    e.preventDefault();
    let tipo = document.getElementById("tipoCategoria").value;
    let cat = document.getElementById("nomeCategoriaNova").value.trim();
    let subcat = document.getElementById("subCategoriaNova").value.trim();
    if (!cat) return alert('Categoria obrigatória');
    let categoriaObj = categorias.find(x=>x.tipo===tipo && x.categoria===cat);
    if(!categoriaObj){categoriaObj={tipo:tipo,categoria:cat,subcategorias:[]};categorias.push(categoriaObj)}
    if (subcat && !categoriaObj.subcategorias.includes(subcat)) categoriaObj.subcategorias.push(subcat);
    saveAll(); renderCategoriasList(); renderCategoriaSelects(); e.target.reset();
  };
  function renderCategoriasList() {
    let html = '<table><thead><tr><th>Tipo</th><th>Categoria</th><th>Subcategorias</th><th></th></tr></thead><tbody>';
    categorias.forEach((cat,i)=>{
      html += `<tr>
        <td>${cat.tipo}</td>
        <td>${cat.categoria}</td>
        <td>
          ${cat.subcategorias.map((sub,j)=>`${sub}<button class="small-btn" onclick="window.delSubcat(${i},${j})">x</button>`).join(', ')}
          <input class="small-input" id="insSub${i}" placeholder="Nova" style="width:60px;">
          <button onclick="window.addSubcat(${i})">Add</button>
        </td>
        <td>
          <button class="small-btn" onclick="window.delCategoria(${i})">Excluir</button>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById("categoriasList").innerHTML = html;
  }
  window.delCategoria=function(idx){categorias.splice(idx,1);saveAll();renderCategoriasList();renderCategoriaSelects();}
  window.addSubcat=function(idx){
    let v=document.getElementById("insSub"+idx).value.trim();
    if(v && !categorias[idx].subcategorias.includes(v)){
      categorias[idx].subcategorias.push(v); saveAll(); renderCategoriasList(); renderCategoriaSelects();
    }
  }
  window.delSubcat=function(i,j){categorias[i].subcategorias.splice(j,1);saveAll();renderCategoriasList();renderCategoriaSelects();}
  renderCategoriasList();

  // ---------- BOX INVESTIMENTO/APORTES ----------
  document.getElementById("investmentForm").onsubmit = function(e){
    e.preventDefault();
    const nomeSocio = document.getElementById("socioName").value.trim();
    const valorInicial = parseFloat(document.getElementById("initialInvestment").value) || 0;
    const valorAporte = parseFloat(document.getElementById("aporteValue").value) || 0;
    const dataAporte = document.getElementById("aporteData").value;
    let inv = investimentos.find(x=>x.socio===nomeSocio);
    if (!inv) {inv={socio:nomeSocio,inicial:0,aportes:[]};investimentos.push(inv);}
    if (valorInicial > 0) inv.inicial = valorInicial;
    if (valorAporte > 0 && dataAporte) inv.aportes.push({valor:valorAporte,data:dataAporte});
    else if (valorAporte > 0 && !dataAporte) {alert('Informe a data do aporte');return;}
    saveAll(); this.reset(); renderInvestmentSummary();
  };
  function renderInvestmentSummary() {
    let html = "";
    investimentos.forEach(x=>{
      let totalAportes = x.aportes.reduce((a,b)=>a+parseFloat(b.valor)||0,0);
      let total = (parseFloat(x.inicial)||0) + totalAportes;
      html += `<p><strong>${x.socio}:</strong> Inicial: ${formatCurrency(x.inicial||0)}<br>
      Aportes: ${formatCurrency(totalAportes)}
      <br><strong>Total: ${formatCurrency(total)}</strong></p>`;
    });
    document.getElementById("investmentSummary").innerHTML = html;
  }
  renderInvestmentSummary();

  // ---------- LANÇAMENTO ENTRADA/SAÍDA ----------
  function renderCategoriaSelects(){
    let entradaSel = document.getElementById("entradaCategoria");
    entradaSel.innerHTML = categorias.filter(x=>x.tipo=="entrada").map(x=>`<option value="${x.categoria}">${x.categoria}</option>`).join('');
    entradaSel.dispatchEvent(new Event('change'));

    let saidaSel = document.getElementById("saidaCategoria");
    saidaSel.innerHTML = categorias.filter(x=>x.tipo=="saida").map(x=>`<option value="${x.categoria}">${x.categoria}</option>`).join('');
    saidaSel.dispatchEvent(new Event('change'));
  }
  renderCategoriaSelects();
  function atualizarEntradaSubcat(){
    let cat = document.getElementById("entradaCategoria").value;
    let obj = categorias.find(x=>x.tipo=="entrada"&&x.categoria==cat);
    let sel = document.getElementById("entradaSubcategoria");
    sel.innerHTML = obj && obj.subcategorias.length?
      obj.subcategorias.map(s=>`<option value="${s}">${s}</option>`).join(''): '<option value="">-</option>';
  }
  function atualizarSaidaSubcat(){
    let cat = document.getElementById("saidaCategoria").value;
    let obj = categorias.find(x=>x.tipo=="saida"&&x.categoria==cat);
    let sel = document.getElementById("saidaSubcategoria");
    sel.innerHTML = obj && obj.subcategorias.length?
      obj.subcategorias.map(s=>`<option value="${s}">${s}</option>`).join(''): '<option value="">-</option>';
  }
  document.getElementById("entradaCategoria").addEventListener("change", atualizarEntradaSubcat);
  document.getElementById("saidaCategoria").addEventListener("change", atualizarSaidaSubcat);

  document.getElementById("entradaForm").onsubmit = function(e){
    e.preventDefault();
    let categoria = document.getElementById("entradaCategoria").value;
    let subcategoria = document.getElementById("entradaSubcategoria").value || '';
    let valor = parseFloat(document.getElementById("entradaValor").value) || 0;
    let data = document.getElementById("entradaData").value;
    if (!valor || !data) return alert('Preencha o valor e data corretamente');
    entradas.push({id:genId(),categoria,subcategoria,valor,data});
    saveAll(); this.reset(); alert('Entrada registrada!');
  };
  document.getElementById("saidaForm").onsubmit = function(e){
    e.preventDefault();
    let categoria = document.getElementById("saidaCategoria").value;
    let subcategoria = document.getElementById("saidaSubcategoria").value || '';
    let valor = parseFloat(document.getElementById("saidaValor").value) || 0;
    let data = document.getElementById("saidaData").value;
    if (!valor || !data) return alert('Preencha o valor e data corretamente');
    saidas.push({id:genId(),categoria,subcategoria,valor,data});
    saveAll(); this.reset(); alert('Saída registrada!');
  };

  // ---------- CONTROLE DE ALUGUEL (Nova lógica para anotações com data) ----------
  function renderAlugueis() {
    let html='<table><thead><tr><th>Profissional</th><th>Períodos</th><th>Valor Mensal</th><th>Início</th><th>Encerramento</th><th>Anotações</th><th>Ações</th></tr></thead><tbody>';
    alugueis.forEach((a,i)=>{
      html+=`<tr>
        <td>${a.profissional}</td>
        <td>${a.periodosSemana}</td>
        <td>${formatCurrency(a.valorMensal)}</td>
        <td>${formatDate(a.dataInicio)}</td>
        <td>${a.dataEncerramento?formatDate(a.dataEncerramento):'-'}</td>
        <td>
          ${(a.anotacoes||[]).map(ant=>`<div class="anotacao-row">${formatDate(ant.data)}: ${ant.texto}</div>`).join('')}
          <button onclick="window.adicionarAnotacaoAluguel(${i})">Nova anotação</button>
        </td>
        <td>
          <button class="small-btn" onclick="window.editAluguel(${i})">Editar</button>
          <button class="small-btn" onclick="window.delAluguel(${i})">Excluir</button>
        </td>
      </tr>`;
    });
    html+='</tbody></table>';
    document.getElementById("listaProfissionais").innerHTML = html;
    document.getElementById("anotacaoAluguelForm").classList.add("hidden");
  }
  window.editAluguel=function(idx){
    const a = alugueis[idx];
    document.getElementById("profissionalNome").value=a.profissional;
    document.getElementById("periodosSemana").value=a.periodosSemana;
    document.getElementById("valorMensal").value=a.valorMensal;
    document.getElementById("dataInicioAluguel").value=a.dataInicio;
    document.getElementById("dataEncerramentoAluguel").value=a.dataEncerramento||"";
    window.aluguelEditando=idx;
  }
  window.delAluguel=function(idx){alugueis.splice(idx,1);saveAll();renderAlugueis();}
  document.getElementById("aluguelForm").onsubmit=function(e){
    e.preventDefault();
    let a = {
      profissional:document.getElementById("profissionalNome").value.trim(),
      periodosSemana:document.getElementById("periodosSemana").value.trim(),
      valorMensal:parseFloat(document.getElementById("valorMensal").value)||0,
      dataInicio:document.getElementById("dataInicioAluguel").value,
      dataEncerramento:document.getElementById("dataEncerramentoAluguel").value||undefined,
      anotacoes: (typeof window.aluguelEditando==="number" && alugueis[window.aluguelEditando])?alugueis[window.aluguelEditando].anotacoes:[] };
    if(!a.profissional || !a.periodosSemana || !a.dataInicio) return alert('Preencha todos os campos obrigatórios');
    if(typeof window.aluguelEditando==="number") {alugueis[window.aluguelEditando]=a; window.aluguelEditando=undefined;}
    else alugueis.push(a);
    saveAll(); this.reset(); renderAlugueis();
  };
  window.adicionarAnotacaoAluguel=function(idx){
    document.getElementById("anotacaoAluguelForm").classList.remove("hidden");
    document.getElementById("idxAluguel").value=idx;
  }
  document.getElementById("anotacaoAluguelForm").onsubmit=function(e){
    e.preventDefault();
    let idx=parseInt(document.getElementById("idxAluguel").value,10);
    let data=document.getElementById("dataAnotacao").value;
    let texto=document.getElementById("textoAnotacao").value.trim();
    if(!data||!texto)return alert('Preencha data e texto');
    alugueis[idx].anotacoes=alugueis[idx].anotacoes||[];
    alugueis[idx].anotacoes.push({data,data,texto});
    saveAll(); this.reset(); renderAlugueis();
  }
  renderAlugueis();

  // ---------- RELATÓRIOS NOVOS ----------
  document.getElementById("relatorioForm").onsubmit = function(e){
    e.preventDefault();
    let dtini = document.getElementById("relatoInicio").value;
    let dtfim = document.getElementById("relatoFim").value;
    let tipo = document.getElementById("tipoRelatorio").value;
    let html = '';
    function filtroDatas(arr){
      return arr.filter(x=>{
        let d = new Date(x.data||x.dataInicio||x.dataEncerramento);
        let di = new Date(dtini), df = new Date(dtfim);
        return (!dtini||d>=di) && (!dtfim||d<=df);
      }); }
    if(tipo=="aporte"){
      html='<h3>Relatório de Aportes</h3><table><tr><th>Sócio</th><th>Valor</th><th>Data</th></tr>';
      investimentos.forEach(x=>x.aportes.filter(y=>{
        let d = new Date(y.data), di=new Date(dtini), df=new Date(dtfim);
        return (!dtini||d>=di)&&(!dtfim||d<=df);
      }).forEach(y=>{
        html += `<tr><td>${x.socio}</td><td>${formatCurrency(y.valor)}</td><td>${formatDate(y.data)}</td></tr>`;
      }));
      html+='</table>';
    } else if(tipo=="entrada"){
      let dados=filtroDatas(entradas);
      html='<h3>Entradas por Categoria</h3><table><tr><th>Categoria</th><th>Subcategoria</th><th>Valor</th><th>Data</th></tr>';
      dados.forEach(x=>{html+=`<tr><td>${x.categoria}</td><td>${x.subcategoria}</td><td>${formatCurrency(x.valor)}</td><td>${formatDate(x.data)}</td></tr>`;});
      html+='</table>';
    } else if(tipo=="saida"){
      let dados=filtroDatas(saidas);
      html='<h3>Saídas por Categoria</h3><table><tr><th>Categoria</th><th>Subcategoria</th><th>Valor</th><th>Data</th></tr>';
      dados.forEach(x=>{html+=`<tr><td>${x.categoria}</td><td>${x.subcategoria}</td><td>${formatCurrency(x.valor)}</td><td>${formatDate(x.data)}</td></tr>`;});
      html+='</table>';
    } else {
      let e=filtroDatas(entradas),s=filtroDatas(saidas);
      let totE = e.reduce((a,b)=>a+(+b.valor||0),0), totS = s.reduce((a,b)=>a+(+b.valor||0),0);
      html = `<h3>Balanço Geral</h3>
        <p>Entradas: <strong>${formatCurrency(totE)}</strong></p>
        <p>Saídas: <strong>${formatCurrency(totS)}</strong></p>
        <p style="font-size:1.1em;">Saldo: <strong style="color:${totE-totS>=0?'green':'red'}">${formatCurrency(totE-totS)}</strong></p>`;
    }
    document.getElementById("relat").innerHTML = html;
  };
})();
</script>
</body>
</html>
